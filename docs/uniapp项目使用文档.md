# 疫苗接种系统 - 使用手册

本文档说明系统的三端（管理员、医生、用户/居民）功能、各模块运行逻辑及业务限制。前端为 UniApp 多端应用（H5/小程序/App），后端为 Spring Boot，基础 URL 默认 `http://localhost:8080`。

**相关文档**：接口详情见 [API.md](API.md)，数据库表结构见 [database.md](database.md)。

---

## 一、角色与入口

| 角色 | 说明 | 前端入口 |
|------|------|----------|
| **管理员（ADMIN）** | 系统配置、用户/疫苗/接种点/公告管理、排期、统计、库存预警、调拨与智能提醒 | 登录后进入管理员页面：用户管理、疫苗管理、接种点管理、排期管理、公告管理、统计大屏等 |
| **医生（DOCTOR）** | 预约审核、待接种核销、派遣信息（查看并标记已读）、发布公告（需管理员审核）、个人档案与接种记录 | 登录后进入医生工作台：预约审核、待接种/录入核销、派遣信息、发布公告 |
| **用户/居民（RESIDENT）** | 宝宝档案、预约接种、接种点查询、我的预约、接种记录、公告查看 | 登录后进入用户端：宝宝档案、接种点信息、预约接种、我的预约、接种记录、公告列表 |

---

## 二、管理员端功能与限制

### 2.1 用户管理

- **功能**：分页查询用户（按用户名、角色、状态筛选）、查看用户详情（家长含宝宝与预约/接种、医生含排班与统计）、新增/编辑用户、重置密码、禁用/恢复、注销、逻辑删除及批量删除。
- **运行逻辑**：
  - 仅 **status=正常（0）** 的用户可登录；禁用（1）后不可登录，恢复后即可。
  - **注销（2）** 为不可恢复，需校验管理员当前密码（请求体 `adminPassword`，请求头 `X-User-Id` 为当前管理员 ID）。
  - 逻辑删除将 `is_deleted=1`，列表与详情默认过滤已删除数据。
- **限制**：密码为明文存储；批量删除为请求体传 ID 数组。

### 2.2 疫苗管理

- **功能**：疫苗信息的增删改查、分页（疫苗名称、状态）；总仓批次管理（批次 CRUD、效期、调拨）。批次管理列表中可查看**疫苗名称**与**保质期（有效期至）**。
- **运行逻辑**：疫苗有上架/下架状态；下架后不影响已有预约与记录，但新建预约时一般仅展示上架疫苗。总仓库存（`vaccine_batch`）仅通过**调拨**减少，详见 [六、库存与调拨架构](#六库存与调拨架构)。
- **限制**：删除疫苗需无关联预约/库存等依赖，否则受外键约束。

### 2.3 接种点管理

- **功能**：接种点增删改查、启用/禁用、**直接指派/清空驻场医生**、按接种点维护**简易库存**（增加、减少、更新预警阈值、直接设置数量、删除某条库存记录）；**接种点按批次库存**查询与**总仓→接种点调拨**、调拨日志查询。
- **运行逻辑**：
  - **禁用** 后：该接种点不可被预约、用户端「接种点列表」不展示。
  - **驻场医生**：管理员在接种点详情内直接选择医生并点击「指派为驻场医生」即可生效；指派后系统向该医生推送一条派遣信息，医生在「派遣信息」模块可查看并标记已读。
  - **清空驻场医生**：点击清空即可，无需二次确认，不改变接种点启用状态。
  - **简易库存**（`vaccine_site_stock`）：用于预警列表与阈值配置；增加/减少时 **quantity** 为必填，支持输入任意正整数。
  - **按批次库存与扣减**：预约/核销的可用量与扣减基于 **site_vaccine_stock**（按批次可用/锁定），详见 [六、库存与调拨架构](#六库存与调拨架构)。调拨后接种点按批次库存增加，核销时扣减接种点该批次的锁定库存。
- **限制**：删除接种点会级联影响库存、预约、记录等；库存减少/设置时不可导致可用库存为负。

### 2.4 派遣记录（管理员）

- **功能**：查看全部派遣记录列表（管理员每次指派驻场医生时自动生成一条记录，供医生端查看）。
- **运行逻辑**：仅查看，不提供「提交调遣申请」；指派操作在接种点管理的「驻场医生」区块完成。

### 2.5 公告管理

- **功能**：公告分页（标题、类型、状态）、待审核列表（医生提交的公告）、详情、意见反馈列表、新增/修改、审核通过/拒绝、下架/上架。
- **运行逻辑**：管理员直接发布的公告可设为已发布；医生提交的公告需管理员审核（approve/reject），通过后才对用户端可见。管理员可下架公告（不彻底删除），下架后仅管理员可见、列表中以灰色展示，可再次上架恢复展示。
- **限制**：不允许彻底删除公告；拒绝时可填写原因，医生端可查看并重新提交。

### 2.6 儿童档案（管理员）

- **功能**：按家长分页查看儿童档案、详情、新增（指定 parentId）、修改、删除。
- **运行逻辑**：与用户端「宝宝档案」为同一批数据，管理员可维护任意家长的宝宝。
- **限制**：删除儿童前需无未完成的预约或需业务上先处理预约/记录。

### 2.7 接种记录管理

- **功能**：分页查询 `record` 表与 `vaccination_record` 表、查看 vaccination_record 详情、新增 record、接种核销（写 vaccination_record）、修改/删除 record。
- **运行逻辑**：完成接种以医生端「完成接种」为主；管理员端可用于补录或核销。核销使用预约单上的 **batch_id**，扣减 **site_vaccine_stock** 的 locked_stock，与医生端逻辑一致。
- **限制**：接种核销需关联有效预约（已排班），扣减逻辑与医生端一致。

### 2.8 预约排期

- **功能**：查看待排班列表（status=5，医生已通过）、全部预约分页（按状态、用户、接种点等）、选择医生与日期/时段进行排期、获取儿童列表与医生列表。
- **运行逻辑**：
  - 预约状态流转：**0 待审批 → 医生审核 → 5 医生已通过待排班 → 管理员排期 → 1 已排班**；排期时指定医生与预约日期/时段，不扣库存。
  - 医生完成接种后状态变为 **2 已完成**，并扣减**接种点按批次库存**（site_vaccine_stock）、写入接种记录。
- **限制**：仅 status=5 或 0 的预约可被排期；排期日期一般限制在合理范围内（如当月及后两个月，由前端或后端校验）。

### 2.9 库存预警

- **功能**：查看库存预警列表（按点库存低于预警阈值，基于 vaccine_site_stock）、批次/效期预警记录、手动执行「百白破剩余率<10%与效期预警并同步供应商」。
- **运行逻辑**：定时任务会扫描批次库存与效期并写入 `stock_alert_log`，可选同步到供应商；手动接口用于立即执行一次。总仓与接种点按批次库存见 [六、库存与调拨架构](#六库存与调拨架构)。
- **限制**：供应商同步依赖配置的供应商 URL，未配置时仅写本地日志。

### 2.10 智能提醒与推送

- **功能**：查看智能提醒推送记录、宣传推送记录；触发「脊灰第3剂提前72小时」推送、麻腮风宣传推送。
- **运行逻辑**：72 小时提醒针对符合条件的儿童与剂次生成推送记录；宣传推送可指定疫苗与内容，向目标用户推送。
- **限制**：实际推送渠道（微信/短信/App）需对接具体通道，系统侧只记录日志。

### 2.11 统计报表

- **功能**：今日接种人数、各疫苗接种次数、近 7 天/每月趋势、疫苗库存统计、低库存预警、热力图、统计大屏聚合等。**统计大屏**仅展示今日接种、7 日合计、近 7 日接种趋势与低库存预警，不再展示各疫苗库存列表。
- **运行逻辑**：基于 `record`、`vaccination_record`、`vaccine_site_stock` 等表聚合查询，不建新表。
- **限制**：热力图与趋势的时间范围、低库存阈值等以接口参数为准（如 threshold、year、dateFrom/dateTo）。

### 2.12 医生统计

- **功能**：按医生 ID 查看该医生账号信息、排班站点、今日预约数、历史接种数等。
- **运行逻辑**：只读汇总，用于管理员查看医生工作量与排班情况。

---

## 三、医生端功能与限制

### 3.1 登录与身份

- 仅 **角色=DOCTOR** 且 **status=正常** 可登录医生端；登录后可见工作台、预约审核、待接种、派遣信息、公告等菜单。

### 3.2 预约审核

- **功能**：查看待审核预约列表（status=0）、对每条预约进行通过或拒绝。
- **运行逻辑**：
  - **通过**：预约状态变为 **5（医生已通过待排班）**，随后由管理员排期（指定医生与日期）。
  - **拒绝**：预约状态变为 **3（已取消）**，家长端可看到「未通过」并可再次预约。
- **限制**：仅能审核状态为 0 的预约；拒绝后家长可重新提交新预约。

### 3.3 待接种与完成接种

- **功能**：查看今日已排班列表（status=1 且预约日期=今日）、未来已排班列表、预约详情（含宝宝健康档案）、对已排班预约执行「完成接种」或「接种核销」。
- **运行逻辑**：
  - **完成接种**（`/doctor/vaccinate/finish/{orderId}`）：校验预约为已排班且未完成，使用预约单上的 **batch_id**，扣减 **site_vaccine_stock** 的 `locked_stock`，写入 `record` 与 `vaccination_record`，预约状态更新为 **2 已完成**；同一预约只能完成一次。
  - **接种核销**（CreateRecordDTO）：针对已排班预约，使用预约的 batch_id 扣减接种点该批次的 locked_stock，填写批号、部位、留观情况等，写入 vaccination_record，同样更新预约状态。
- **限制**：仅能对自己被分配的、且状态为已排班（1）的预约进行完成/核销；库存不足时扣减失败，事务回滚。

### 3.4 派遣信息

- **功能**：查看管理员指派驻场医生时推送的派遣信息列表、对未读信息点击「标记已读」。
- **运行逻辑**：管理员在接种点管理内直接指派驻场医生后，系统自动向该医生推送一条派遣信息（状态=已推送）；医生在列表中查看后点击「标记已读」更新为已读。无审批流程。

### 3.5 发布公告

- **功能**：提交公告（待审核）、查看我提交的公告、被拒后重新提交、撤回待审核公告、对公告提交意见反馈。
- **运行逻辑**：医生提交的公告初始为待审核（PENDING）；管理员审核通过后对用户端展示，拒绝后可填原因，医生可修改后重新提交。
- **限制**：仅能撤回未审核的公告；已发布公告由管理员管理。

### 3.6 医生档案与接种记录

- **功能**：查看当前医生档案信息、历史接种记录列表（本人完成的接种）。
- **运行逻辑**：只读，用于医生查看自己的执业信息与工作量。

---

## 四、用户端（居民/家长）功能与限制

### 4.1 登录与注册

- **功能**：用户名+密码登录、注册（若开放）、校验用户名是否存在。
- **运行逻辑**：仅 **status=正常** 可登录；登录成功更新 last_login_time。
- **限制**：注册接口若未对角色做限制，需由管理员或业务规则控制仅允许注册为 RESIDENT。

### 4.2 宝宝档案

- **功能**：分页查看当前家长的儿童档案、详情、新增、修改、删除。
- **运行逻辑**：仅能操作 **parent_id=当前登录用户** 的儿童；新建预约时可选择宝宝，系统会校验儿童归属。
- **限制**：删除宝宝前若有未完成预约需先取消或完成，否则可能受外键或业务规则限制。

### 4.3 接种点信息

- **功能**：查看接种点列表（含各疫苗库存、驻场医生）。
- **运行逻辑**：接口 **仅返回 status=启用** 的接种点；禁用接种点不在列表中展示且不可选。可用库存基于 **site_vaccine_stock**（按接种点+疫苗+批次汇总，未过期），实际可预约数量以「预约前查库存」接口为准。
- **限制**：库存为实时查询，不包含预约创建时的占位。

### 4.4 预约接种

- **功能**：查询某疫苗某接种点的可用库存、创建预约（选择疫苗、接种点、日期、可选宝宝与时段）。
- **运行逻辑**：
  - 创建预约时后端校验：接种点启用、**接种点按批次可用库存充足**、用户与儿童有效；按 **FEFO**（先过期先出）从 **site_vaccine_stock** 取一批次并**锁定**（available_stock -= 1，locked_stock += 1），预约单写入 **batch_id**。
  - 之后由医生审核 → 管理员排期 → 医生完成接种时按该 batch_id 扣减 locked_stock、写接种记录。
- **限制**：同一儿童同一疫苗的剂次、间隔等业务规则由后端或前端校验（如适用月龄、间隔天数）；预约日期一般不能为过去日期。

### 4.5 我的预约

- **功能**：分页查看当前用户的预约列表，按状态（待审批/已通过/未通过/已结束等）、宝宝、疫苗等筛选；查看预约详情。
- **运行逻辑**：仅能查看 **user_id=当前用户** 的预约；状态与后端一致（0/5/1/2/3/4 等）。
- **限制**：已取消或已过期的预约不可再操作；被拒后可重新发起新预约。

### 4.6 接种记录

- **功能**：查看「我的」接种记录（按用户）、按宝宝查看该宝宝的接种记录。
- **运行逻辑**：数据来自 record 或 vaccination_record，关联疫苗名、接种点名、医生名等展示；仅能查看本人或本人宝宝的数据。
- **限制**：只读，无修改/删除入口。

### 4.7 公告列表

- **功能**：分页查看已发布的公告、点击查看公告详情。
- **运行逻辑**：仅展示 **status=已发布** 且管理员审核通过的公告；医生提交未审核或已拒绝的不展示。
- **限制**：可选记录已读（user_notice_read），用于已读未读区分。

---

## 五、预约状态与流程汇总

| 状态值 | 含义         | 可执行操作 |
|--------|--------------|------------|
| 0      | 待审批       | 医生：通过→5 / 拒绝→3 |
| 5      | 医生已通过待排班 | 管理员：排期→1 |
| 1      | 已排班       | 医生：完成接种→2（扣接种点批次锁定库存、写记录） |
| 2      | 已完成       | 无后续操作 |
| 3      | 已取消       | 用户可重新预约 |
| 4      | 已过期       | 无后续操作 |

**库存**：创建预约时在接种点按批次库存（site_vaccine_stock）上 **FEFO 锁定**（available→locked）；医生「完成接种」时扣减该批次的 **locked_stock**。总仓（vaccine_batch）仅通过管理员**调拨**减少。

---

## 六、库存与调拨架构

本节说明总仓与接种点库存的联动关系，便于理解预约、核销与调拨流程。表结构细节见 [database.md](database.md)，接口见 [API.md](API.md)。

### 6.1 目标架构

```
【总仓库存 vaccine_batch】
        ↓ 调拨（管理员）
【接种点库存 site_vaccine_stock】
        ↓ 预约锁定 → 核销消耗
【接种记录 vaccination_record】
```

- **总仓**：`vaccine_batch.stock` 仅通过**调拨**减少，不再被预约/核销直接扣减。
- **接种点**：`site_vaccine_stock` 按批次维护 `available_stock`、`locked_stock`，预约时 FEFO 锁定，核销时扣减。
- **调拨日志**：`stock_transfer_log` 记录每次调拨，便于追溯。

### 6.2 核心表（与 database.md 互补）

- **site_vaccine_stock**（接种点库存，按批次）：site_id、batch_id、available_stock、locked_stock、created_at/updated_at。
- **stock_transfer_log**（调拨日志）：batch_id、from_type/from_id、to_type/to_id、quantity、operator_id、transfer_time。

### 6.3 模块与流程概览

| 模块 | 职责 | 说明 |
|------|------|------|
| 总仓批次 | 批次 CRUD、FEFO（总仓维度）、过期标记、销毁、调拨时扣减 | VaccineBatchService |
| 接种点库存 | 按批次可用/锁定、FEFO（接种点+疫苗）、锁定/回滚/核销扣减、过期清零 | SiteVaccineStockService |
| 调拨 | 总仓→接种点原子调拨、写日志、分页查日志 | StockTransferService |
| 预约 | 校验接种点可用库存、FEFO 锁定 site_vaccine_stock、写预约单（含 batch_id） | AppointmentServiceImpl |
| 核销 | 使用预约的 batch_id，扣减 site_vaccine_stock.locked_stock，写接种记录 | VaccinationRecordServiceImpl |
| 定时任务 | 过期联动：先清零各接种点该批次库存，再标记批次过期 | StockAndReminderTask.runBatchExpire |

### 6.4 核心流程简述

1. **调拨（管理员）**：校验 vaccine_batch.stock ≥ quantity → 扣减总仓 → 增加/创建 site_vaccine_stock.available_stock → 插入 stock_transfer_log；事务保证原子性。
2. **预约（家长端）**：按接种点+疫苗汇总 site_vaccine_stock 可用量（未过期）→ FEFO 取一批次 → available_stock -= 1、locked_stock += 1，预约单写入 batch_id。
3. **核销（医生端）**：使用预约的 batch_id → site_vaccine_stock.locked_stock -= 1 → 生成疫苗编号、写入 vaccination_record；事务内完成。
4. **过期联动（定时任务）**：对过期批次先清零各接种点该 batch_id 的 available_stock、locked_stock，再标记 vaccine_batch.status=过期。

### 6.5 管理员端 API（库存/调拨）

- **总仓库存**：`GET /admin/batch/page`、`/admin/batch/by-status`
- **接种点库存**：`GET /admin/stock/site-stock?siteId=`
- **执行调拨**：`POST /admin/stock/transfer`，Body: `{ "batchId", "siteId", "quantity" }`，可选 `operatorId`
- **调拨日志**：`GET /admin/stock/transfer-logs?current=&size=&batchId=&fromTime=&toTime=`

### 6.6 保留的旧表与兼容

- **vaccine_site_stock**：保留，用于按疫苗+接种点的简易库存与预警（预警列表、阈值配置）。预约/核销的**库存判断与扣减**已改为基于 **site_vaccine_stock**。

---

## 七、前端页面与模块对应（简要）

- **登录**：`pages/login/login` — 根据 role 跳转管理员/医生/用户首页。
- **管理员**：用户管理(users/user-detail/user-edit)、疫苗(vaccine)、接种点(site/site-detail)、排期(schedule/list)、公告(notice)、统计(stats/dashboard) 等。
- **医生**：工作台(workbench)、预约审核(review/list)、待接种与核销(vaccinate/list)、派遣信息(dispatch/list)、发布公告(notice)。
- **用户**：宝宝档案(user/child/list-add-edit)、接种点(user/site/list)、预约(order/add、user/appointment/list)、接种记录(user/record/list、record/list-myRecord)、公告(notice/list)。
- **公共**：首页(home)、疫苗列表(vaccine/list)、公告(notice/list) 等。

具体页面标题与路由以 `pages.json` 及各页面内标题为准。

---

## 八、项目规模与代码统计

本节为代码行数统计与简要评估，便于了解项目体量。统计范围与口径如下。

### 8.1 统计范围

- **后端**：`vaccine_system` 下 `src/main` 中的业务与配置代码（Java + Mapper XML + application.properties），不含测试代码。
- **前端**：`vaccine.app` 下**业务相关**代码（页面、组件、公共模块、状态、入口与配置），**不含** `uni_modules`、`wxcomponents`、`static`、`unpackage` 等第三方/构建产物。
- **有效代码**：按「非空行」统计，即排除纯空行后的行数。

### 8.2 后端（vaccine_system）

| 类型 | 文件数 | 有效代码行数（约） |
|------|--------|-------------------|
| Java（controller / service / model / mapper / config / common / task 等） | 127+ | **约 7 350** |
| Mapper XML（Record / Stats / VaccineInventory / VaccineSiteStock 等） | 4 | **约 142** |
| application.properties | 1 | **29** |
| **后端合计** | **132+** | **约 7 520** |

### 8.3 前端（vaccine.app，仅业务代码）

| 目录/文件 | 文件数 | 有效代码行数（约） |
|-----------|--------|-------------------|
| pages（登录、首页、预约、记录、统计、医生端、管理端等） | 27 | **约 5 740** |
| common（request、util、permission、html-parser 等） | 6 | **约 1 160** |
| components（AppHeader、page-foot、u-link、product 等） | 6 | **约 460** |
| store（index、counter） | 2 | **约 170** |
| platforms（app-plus 示例页） | 6 | **约 650** |
| App.vue / main.js / pages.json / uni.scss | 4 | **约 395** |
| **前端合计** | **51** | **约 8 575** |

### 8.4 项目总计与评估

| 项目 | 有效代码行数（约） |
|------|-------------------|
| 后端 | **约 7 520** |
| 前端 | **约 8 575** |
| **合计** | **约 16 100** |

（若含空行与注释的「物理行」统计，总量约在 **1.8 万～2 万行** 量级。）

- **规模**：有效代码约 **1.6 万行**，属于**中大型毕业设计/课程项目**规模，前后端体量相当，结构完整。
- **后端**：Spring Boot + MyBatis-Plus，分层清晰；覆盖预约、接种记录、接种点、疫苗与库存、统计、公告、医生排班及总仓调拨、接种点按批次库存等，含统一异常处理、安全配置、定时任务（库存预警与提醒、批次过期联动）。
- **前端**：uni-app（Vue 2/3），支持多端；页面与路由完整（用户、医生、管理员、统计大屏等）；公共逻辑集中在 common 与 store，可维护性较好。
- **适用场景**：作为**本科毕业设计**，代码量与功能广度、技术栈深度均达到较高水平，具备撰写论文、答辩演示和进一步扩展的基础。

*统计方法：基于仓库内源码文件逐类统计；有效行按「非空行」计。*

---

## 九、注意事项

1. **密码**：当前为明文存储，生产环境应改为加密存储并做好权限与审计。
2. **跨域与基础 URL**：前端请求需配置与后端一致的 baseURL；后端已提供 CORS 配置时，注意端口与协议一致。
3. **权限**：接口按路径区分 admin/doctor/user/common，后端通过登录角色校验，前端按 role 控制菜单与按钮显示。
4. **数据一致性**：预约锁定与核销扣减在同一事务中，失败会整体回滚；接种点按批次库存（site_vaccine_stock）保证预约与核销一致；简易库存（vaccine_site_stock）使用乐观锁 version 用于并发控制。
5. **文档**：接口详情见 [API.md](API.md)，数据库表结构见 [database.md](database.md)；本手册与 API、数据库文档保持一致，业务变更时请同步更新。

---

*文档版本与项目一致，如有业务变更请同步更新本手册与 API、数据库文档。*
