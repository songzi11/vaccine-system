<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tjut.edu.vaccine_system.mapper.VaccineSiteStockMapper">

    <!-- 扣减库存：仅当 stock > 0 时减 1，保证不超卖 -->
    <update id="decrementStock">
        UPDATE vaccine_site_stock
        SET stock = stock - 1, update_time = NOW()
        WHERE vaccine_id = #{vaccineId} AND site_id = #{siteId} AND stock > 0
    </update>

    <!-- 增加库存 -->
    <update id="incrementStock">
        UPDATE vaccine_site_stock
        SET stock = stock + #{quantity}, update_time = NOW()
        WHERE vaccine_id = #{vaccineId} AND site_id = #{siteId}
    </update>

    <!-- 减少库存：仅当 stock >= quantity 时更新 -->
    <update id="reduceStock">
        UPDATE vaccine_site_stock
        SET stock = stock - #{quantity}, update_time = NOW()
        WHERE vaccine_id = #{vaccineId} AND site_id = #{siteId} AND stock >= #{quantity}
    </update>
</mapper>
